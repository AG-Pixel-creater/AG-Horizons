rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Blocklist functions
    function blockedKeywordRegex() {
      return '(?i)\\b(porn|pornhub|xvideos|xhamster|xnxx|redtube|youporn|pornography|porn.com|adult|xxx|escort|cam|hentai|nsfw|nude|erotic|sex)\\b';
    }

    function blockedDomainRegex() {
      return '(?i)(pornhub\\.com|xvideos\\.com|xhamster\\.com|xnxx\\.com|redtube\\.com|youporn\\.com|porn\\.com)';
    }

    function isCleanString(s) {
      return !(s is string && s.matches(blockedKeywordRegex()));
    }

    function isCleanLink(l) {
      return !(l is string && (l.matches(blockedDomainRegex()) || l.matches(blockedKeywordRegex())));
    }

    // Websites collection
    match /websites/{website} {
      allow read: if request.auth != null; // only logged-in users can read
      allow create, update: if request.auth != null
                            && isCleanString(request.resource.data.website_title)
                            && isCleanString(request.resource.data.website_description)
                            && isCleanLink(request.resource.data.website_link);
      allow delete: if false;
    }

    // Images collection
    match /images/{imageId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
                            && isCleanString(request.resource.data.title)
                            && isCleanString(request.resource.data.description)
                            && isCleanLink(request.resource.data.title_link)
                            && !(request.resource.data.image_url is string && request.resource.data.image_url.matches(blockedDomainRegex()));
      allow delete: if false;
    }

    // Videos collection
    match /videos/{videoId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
                            && isCleanString(request.resource.data.title)
                            && isCleanString(request.resource.data.description)
                            && isCleanLink(request.resource.data.title_link)
                            && !(request.resource.data.video_url is string && request.resource.data.video_url.matches(blockedDomainRegex()));
      allow delete: if false;
    }

    // Legacy searchData collection
    match /searchData/{document} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null
                            && isCleanString(request.resource.data.title)
                            && isCleanString(request.resource.data.description)
                            && isCleanLink(request.resource.data.url);
      allow delete: if false;
    }

    // Health check
    match /_health_check_/{document} {
      allow read: if request.auth != null;
    }
  }
}